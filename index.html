<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SolarRide - Solar Bike Charging</title>
    <script>
        // 在脚本加载前就拦截警告和错误
        (function() {
            const originalWarn = console.warn;
            const originalError = console.error;
            
            // 过滤 Tailwind CSS 生产环境警告
            console.warn = function(...args) {
                const message = args.join(' ');
                if (message.includes('cdn.tailwindcss.com should not be used in production') ||
                    message.includes('tailwindcss.com/docs/installation')) {
                    return;
                }
                originalWarn.apply(console, args);
            };
            
            // 过滤 Google Analytics、浏览器扩展等无关错误
            console.error = function(...args) {
                const message = args.join(' ');
                if (message.includes('google-analytics') ||
                    message.includes('ERR_CONNECTION_CLOSED') ||
                    message.includes('chunk-common') ||
                    message.includes('temushuju.com') ||
                    message.includes('unionContentScript') ||
                    message.includes('AxiosError') && message.includes('Network Error')) {
                    return;
                }
                originalError.apply(console, args);
            };
        })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="custom.css">
    <!-- QR Code Generator Library - qrcodejs -->
    <script src="https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        /* 主框架样式 - iPhone 16 Pro 模拟 */
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
        }

        /* iPhone 16 Pro 框架 */
        .iphone-16-pro-frame {
            width: 393px;
            height: 852px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            border-radius: 55px;
            padding: 6px;
            box-shadow: 
                0 0 0 1px rgba(255, 255, 255, 0.1),
                0 30px 80px rgba(0, 0, 0, 0.5),
                inset 0 0 0 1px rgba(255, 255, 255, 0.05);
            position: relative;
            margin: 20px auto;
        }

        /* 钛金属边框效果 */
        .iphone-16-pro-frame::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 57px;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.3) 0%,
                rgba(255, 255, 255, 0.1) 25%,
                rgba(0, 0, 0, 0.3) 50%,
                rgba(255, 255, 255, 0.1) 75%,
                rgba(255, 255, 255, 0.3) 100%);
            z-index: -1;
            opacity: 0.6;
        }

        /* 动态岛（Dynamic Island）- 已隐藏 */
        .iphone-16-pro-frame::after {
            content: '';
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            width: 126px;
            height: 37px;
            background: #000;
            border-radius: 19px;
            z-index: 100;
            box-shadow: 
                inset 0 2px 4px rgba(0, 0, 0, 0.5),
                0 2px 8px rgba(0, 0, 0, 0.3);
            display: none; /* 隐藏摄像头/灵动岛 */
        }

        /* 屏幕区域 */
        .iphone-screen {
            width: 100%;
            height: 100%;
            background: #000;
            border-radius: 49px;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(0, 0, 0, 0.3);
        }

        /* 动态岛内容区域（在屏幕内） */
        .dynamic-island {
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            width: 126px;
            height: 37px;
            background: #000;
            border-radius: 19px;
            z-index: 1000;
            display: none; /* 隐藏灵动岛 */
            align-items: center;
            justify-content: center;
            box-shadow: 
                inset 0 2px 4px rgba(0, 0, 0, 0.5),
                0 2px 8px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        /* 动态岛内部指示器 - 前置摄像头 - 已隐藏 */
        .dynamic-island::before {
            content: '';
            width: 6px;
            height: 6px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            box-shadow: 
                0 0 4px rgba(255, 255, 255, 0.3),
                inset 0 0 2px rgba(0, 0, 0, 0.5);
            display: none; /* 隐藏前置摄像头指示器 */
        }

        /* 动态岛内部指示器 - 传感器 - 已隐藏 */
        .dynamic-island::after {
            content: '';
            position: absolute;
            right: 8px;
            width: 2px;
            height: 2px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: none; /* 隐藏传感器指示器 */
        }

        /* iframe 容器 */
        .iframe-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            overflow: hidden;
            background: #fff;
        }

        .main-iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
            transition: opacity 0.3s ease;
        }

        .main-iframe.loading {
            opacity: 0.5;
        }

        /* 底部导航栏 */
        .main-bottom-nav {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 88px;
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            z-index: 1001;
            padding-bottom: 34px;
            border-top: 0.5px solid rgba(0, 0, 0, 0.1);
        }

        /* Home Indicator */
        .home-indicator {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 134px;
            height: 5px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
            z-index: 1002;
        }

        /* 响应式设计 - 移动端适配 */
        @media (max-width: 480px), (max-height: 900px) {
            body {
                background: #000;
            }

            .iphone-16-pro-frame {
                width: 100vw;
                height: 100vh;
                height: 100dvh; /* 动态视口高度，适配移动浏览器地址栏 */
                border-radius: 0;
                margin: 0;
                padding: 0;
                box-shadow: none;
            }

            .iphone-screen {
                border-radius: 0;
            }

            .iphone-16-pro-frame::before {
                display: none;
            }

            .iphone-16-pro-frame::after {
                display: none;
            }

            .dynamic-island {
                top: max(8px, env(safe-area-inset-top));
            }
        }
        
        /* 触摸优化 */
        * {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        /* 防止文本选择（移动端体验优化） */
        button, .nav-item, .nav-center-btn {
            -webkit-user-select: none;
            user-select: none;
        }

        /* 确保 iframe 内容可以滚动 */
        .main-iframe {
            -webkit-overflow-scrolling: touch;
        }

        /* 添加微妙的边框高光效果 */
        .iphone-16-pro-frame {
            position: relative;
        }

        /* 侧边按钮模拟（可选） */
        .iphone-16-pro-frame .side-button {
            position: absolute;
            left: -3px;
            top: 120px;
            width: 3px;
            height: 50px;
            background: linear-gradient(to right, rgba(0, 0, 0, 0.3), transparent);
            border-radius: 2px 0 0 2px;
        }

        .iphone-16-pro-frame .side-button.right {
            left: auto;
            right: -3px;
            top: 180px;
            background: linear-gradient(to left, rgba(0, 0, 0, 0.3), transparent);
            border-radius: 0 2px 2px 0;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .nav-item.active {
            color: #34C759;
        }

        .nav-item:not(.active) {
            color: #9ca3af;
        }

        .nav-item i {
            font-size: 20px;
            margin-bottom: 4px;
            transition: transform 0.2s ease;
        }

        .nav-item.active i {
            transform: scale(1.1);
        }

        .nav-item span {
            font-size: 12px;
            font-weight: 500;
        }

        .nav-center-btn {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #34C759 0%, #30D158 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(52, 199, 89, 0.4), 0 2px 8px rgba(52, 199, 89, 0.2);
            transform: translateY(-8px);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .nav-center-btn:active {
            transform: translateY(-8px) scale(0.95);
        }

        .nav-center-btn i {
            color: white;
            font-size: 20px;
        }

        /* 隐藏子页面的底部导航 */
        .main-iframe + * {
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- iPhone 16 Pro 框架 -->
    <div class="iphone-16-pro-frame">
        <div class="iphone-screen">
            <!-- 动态岛 -->
            <div class="dynamic-island"></div>
            
            <!-- iframe 容器 -->
            <div class="iframe-container">
                <iframe 
                    id="mainFrame" 
                    class="main-iframe" 
                    src="home.html" 
                    frameborder="0"
                    allowfullscreen>
                </iframe>
            </div>

            <!-- 主框架底部导航栏 -->
            <div class="main-bottom-nav">
        <div class="flex items-center justify-around h-full">
            <!-- Home -->
            <div class="nav-item active" data-page="home.html" data-nav="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </div>
            
            <!-- Map -->
            <div class="nav-item" data-page="map.html" data-nav="map">
                <i class="fas fa-map"></i>
                <span>Map</span>
            </div>
            
            <!-- Scan (Center Button) -->
            <div class="nav-center-btn" id="scanBtn">
                <i class="fas fa-qrcode"></i>
            </div>
            
            <!-- Riders -->
            <div class="nav-item" data-page="friends.html" data-nav="friends">
                <i class="fas fa-users"></i>
                <span>Riders</span>
            </div>
            
            <!-- Me -->
            <div class="nav-item" data-page="me.html" data-nav="me">
                <i class="fas fa-user"></i>
                <span>Me</span>
            </div>
            
            <!-- Home Indicator -->
            <div class="home-indicator"></div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrCodeModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center px-4" onclick="if(event.target === this) closeQRCodeModal()">
        <div class="bg-white rounded-3xl p-6 max-w-sm w-full card-shadow-lg transform transition-all duration-300 scale-95 opacity-0" id="qrCodeModalContent" onclick="event.stopPropagation()">
            <div class="text-center mb-6">
                <div class="w-16 h-16 mx-auto mb-4 gradient-bg rounded-full flex items-center justify-center">
                    <i class="fas fa-qrcode text-white text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Scan QR Code</h3>
                <p class="text-sm text-gray-600 mb-4">Scan this QR code to unlock the charging station</p>
                
                <!-- QR Code Container -->
                <div class="bg-white p-4 rounded-2xl border-2 border-gray-100 inline-block mb-4">
                    <div id="qrcode" class="flex items-center justify-center min-w-[200px] min-h-[200px]"></div>
                </div>
                
                <div class="text-xs text-gray-500">
                    <i class="fas fa-info-circle mr-1"></i>
                    Point your camera at the QR code
                </div>
            </div>
            <button class="w-full gradient-bg text-white py-3 rounded-2xl font-bold text-sm card-shadow hover:opacity-90 transition-opacity" onclick="closeQRCodeModal()">
                Close
            </button>
        </div>
    </div>

    <script>
        // 静默 Google Analytics 连接错误（不影响应用功能）
        // 这个错误通常来自 Vercel 自动集成的 Analytics 或浏览器扩展
        
        // 方法1: 拦截全局错误事件
        window.addEventListener('error', function(event) {
            const errorMsg = event.message || '';
            const errorSource = event.filename || '';
            
            if (errorMsg.includes('google-analytics') || 
                errorMsg.includes('analytics') ||
                errorMsg.includes('ERR_CONNECTION_CLOSED') ||
                errorSource.includes('google-analytics') ||
                errorSource.includes('chunk-common')) {
                event.preventDefault();
                event.stopPropagation();
                return true;
            }
        }, true);
        
        // 方法2: 拦截未处理的 Promise 拒绝
        window.addEventListener('unhandledrejection', function(event) {
            const reason = event.reason || '';
            const reasonStr = String(reason);
            
            if (reasonStr.includes('google-analytics') || 
                reasonStr.includes('ERR_CONNECTION_CLOSED') ||
                reasonStr.includes('analytics')) {
                event.preventDefault();
                return true;
            }
        });
        
        // 方法3: 拦截 fetch/XMLHttpRequest 中的 Google Analytics 请求
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const url = args[0];
            if (typeof url === 'string' && (url.includes('google-analytics') || url.includes('google-analytics.com'))) {
                // 静默处理 Google Analytics 请求失败
                return Promise.resolve(new Response('', { status: 200, statusText: 'OK' }));
            }
            return originalFetch.apply(this, args).catch(function(error) {
                if (error.message && error.message.includes('ERR_CONNECTION_CLOSED') && 
                    args[0] && typeof args[0] === 'string' && (args[0].includes('google-analytics') || args[0].includes('google-analytics.com'))) {
                    return Promise.resolve(new Response('', { status: 200 }));
                }
                throw error;
            });
        };
        
        // 方法4: 拦截 XMLHttpRequest（有些脚本可能使用 XHR 而不是 fetch）
        const originalXHROpen = XMLHttpRequest.prototype.open;
        const originalXHRSend = XMLHttpRequest.prototype.send;
        
        XMLHttpRequest.prototype.open = function(method, url, ...rest) {
            if (typeof url === 'string' && (url.includes('google-analytics') || url.includes('google-analytics.com'))) {
                this._isAnalyticsRequest = true;
            }
            return originalXHROpen.apply(this, [method, url, ...rest]);
        };
        
        XMLHttpRequest.prototype.send = function(...args) {
            if (this._isAnalyticsRequest) {
                // 静默处理 Google Analytics 请求
                this.onload = function() {};
                this.onerror = function() {};
                return;
            }
            return originalXHRSend.apply(this, args);
        };
        
        // 页面路由配置
        const pageRoutes = {
            'home': 'home.html',
            'map': 'map.html',
            'friends': 'friends.html',
            'me': 'me.html',
            'charging': 'charging.html',
            'station-detail': 'station-detail.html',
            'subscription': 'subscription.html',
            'stations-list': 'stations-list.html',
            'my-activities': 'my-activities.html'
        };

        // 获取 DOM 元素
        const mainFrame = document.getElementById('mainFrame');
        const navItems = document.querySelectorAll('.nav-item');
        const scanBtn = document.getElementById('scanBtn');

        // 当前活动页面
        let currentPage = 'home';

        /**
         * 切换页面
         * @param {string} pageName - 页面名称
         * @param {boolean} updateNav - 是否更新导航状态
         */
        function switchPage(pageName, updateNav = true) {
            if (!pageRoutes[pageName]) {
                console.warn(`页面 ${pageName} 不存在`);
                return;
            }

            const pageUrl = pageRoutes[pageName];
            
            // 如果已经是当前页面，不执行切换
            if (currentPage === pageName && mainFrame.src.includes(pageUrl)) {
                return;
            }

            // 添加加载状态
            mainFrame.classList.add('loading');

            // 切换 iframe 源
            mainFrame.src = pageUrl;
            currentPage = pageName;

            // 更新导航状态
            if (updateNav) {
                updateNavigation(pageName);
            }

            // 设置超时保护（先设置，防止页面加载失败）
            let timeoutId = setTimeout(function() {
                if (mainFrame.classList.contains('loading')) {
                    console.warn('Page loading timeout after 2s, removing loading state for:', pageUrl);
                    mainFrame.classList.remove('loading');
                }
            }, 2000);

            // 设置加载完成处理
            mainFrame.onload = function() {
                console.log('iframe onload fired for:', pageUrl);
                clearTimeout(timeoutId);
                
                // 使用 setTimeout 确保页面完全渲染后再移除loading状态
                setTimeout(function() {
                    if (mainFrame.classList.contains('loading')) {
                        mainFrame.classList.remove('loading');
                        console.log('Loading state removed for:', pageUrl);
                    }
                }, 150);
                
                // 隐藏子页面的底部导航栏
                try {
                    const iframeDoc = mainFrame.contentDocument || mainFrame.contentWindow.document;
                    const subNavs = iframeDoc.querySelectorAll('.bottom-nav, #subBottomNav');
                    subNavs.forEach(nav => {
                        nav.style.display = 'none';
                    });
                } catch (e) {
                    // Cross-origin restrictions, cannot access iframe content
                    console.log('Cannot access iframe content');
                }
            };
        }

        /**
         * 更新导航栏状态
         * @param {string} activePage - 当前活动页面
         */
        function updateNavigation(activePage) {
            navItems.forEach(item => {
                const navType = item.getAttribute('data-nav');
                if (navType === activePage) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // 绑定导航项点击事件
        navItems.forEach(item => {
            item.addEventListener('click', function() {
                const pageName = this.getAttribute('data-nav');
                switchPage(pageName, true);
            });
        });

        // Scan button click event - Show QR Code Modal
        scanBtn.addEventListener('click', function() {
            showQRCodeModal();
        });

        // Show QR Code Modal
        function showQRCodeModal() {
            const modal = document.getElementById('qrCodeModal');
            const modalContent = document.getElementById('qrCodeModalContent');
            const qrcodeContainer = document.getElementById('qrcode');
            
            // 清除之前的二维码
            qrcodeContainer.innerHTML = '';
            
            // 生成虚拟的二维码数据（可以是用户ID、充电站ID等）
            const qrData = `SOLARRIDE://charge/${Date.now()}`;
            
            // 使用QRCode库生成二维码
            try {
                if (typeof QRCode !== 'undefined') {
                    // 使用qrcodejs2库
                    new QRCode(qrcodeContainer, {
                        text: qrData,
                        width: 200,
                        height: 200,
                        colorDark: '#000000',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.H
                    });
                } else {
                    throw new Error('QRCode library not loaded');
                }
            } catch (error) {
                console.error('QR Code generation error:', error);
                // 如果生成失败，显示占位符
                qrcodeContainer.innerHTML = `
                    <div class="w-48 h-48 bg-gray-200 rounded-lg flex items-center justify-center border-2 border-dashed border-gray-300">
                        <div class="text-center text-gray-500">
                            <i class="fas fa-qrcode text-4xl mb-2"></i>
                            <div class="text-xs font-medium">QR Code</div>
                            <div class="text-[10px] mt-1">示例二维码</div>
                        </div>
                    </div>
                `;
            }
            
            // 显示模态框
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        // Close QR Code Modal
        function closeQRCodeModal() {
            const modal = document.getElementById('qrCodeModal');
            const modalContent = document.getElementById('qrCodeModalContent');
            
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // 监听 iframe 内的页面跳转（通过 postMessage）
        window.addEventListener('message', function(event) {
            // 验证消息来源（可选，提高安全性）
            // if (event.origin !== window.location.origin) return;

            if (event.data && event.data.type === 'navigate') {
                const targetPage = event.data.page;
                const location = event.data.location; // 位置信息
                
                // 如果目标页面是map且有位置信息，保存位置信息以便传递给map页面
                if (targetPage === 'map' && location) {
                    // 将位置信息存储到sessionStorage，map页面可以从那里读取
                    sessionStorage.setItem('navigateLocation', JSON.stringify(location));
                }
                
                switchPage(targetPage, event.data.updateNav !== false);
            } else if (event.data && event.data.type === 'pageLoaded') {
                // 子页面通知已完全加载
                if (mainFrame.classList.contains('loading')) {
                    mainFrame.classList.remove('loading');
                }
            }
        });

        // 初始化：页面加载完成后处理
        mainFrame.onload = function() {
            mainFrame.classList.remove('loading');
            // 尝试隐藏子页面的底部导航（如果同源）
            try {
                const iframeDoc = mainFrame.contentDocument || mainFrame.contentWindow.document;
                const subNavs = iframeDoc.querySelectorAll('.bottom-nav, #subBottomNav');
                subNavs.forEach(nav => {
                    nav.style.display = 'none';
                });
            } catch (e) {
                // Cross-origin restrictions, cannot access iframe content
                // Sub-pages will hide navigation through their own scripts
            }
        };

        // Handle iframe loading errors
        mainFrame.onerror = function() {
            mainFrame.classList.remove('loading');
            console.error('Page loading failed');
        };
    </script>
</body>
</html>
